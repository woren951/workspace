version: '3.5'

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 182.16.240.0/24

volumes:
  mysql:
    driver: local
  redis:
    driver: local
  phpmyadmin:
    driver: local
  elasticsearch:
    driver: local

services:
### MySQL ################################################
    mysql-8:
      build:
        context: ./mysql
        args:
          - MYSQL_VERSION=8.0.28
      command: --max_allowed_packet=32505856
      environment:
        - MYSQL_DATABASE=${MYSQL_DATABASE}
        - MYSQL_USER=${MYSQL_USER}
        - MYSQL_PASSWORD=${MYSQL_PASSWORD}
        - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        - TZ=${MYSQL_TIMEZONE}
      volumes:
        - ${DATA_PATH_HOST}/mysql-8:/var/lib/mysql
        - ./mysql/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
        # logs
        - ./.logs/mysql-8:/var/log/mysql
      ports:
        - "${MYSQL_PORT}:3306"
      depends_on:
        - phpmyadmin

### PhpMyAdmin ###########################################
    phpmyadmin:
      build: ./phpmyadmin
      environment:
        - PMA_ARBITRARY=1
        - MYSQL_USER=${PMA_USER}
        - MYSQL_PASSWORD=${PMA_PASSWORD}
        - MYSQL_ROOT_PASSWORD=${PMA_ROOT_PASSWORD}
        - MAX_EXECUTION_TIME=${PMA_MAX_EXECUTION_TIME}
        - MEMORY_LIMIT=${PMA_MEMORY_LIMIT}
        - UPLOAD_LIMIT=${PMA_UPLOAD_LIMIT}
      ports:
        - "${PMA_PORT}:80"

### PostgreSQL ###########################################
    postgres:
      build:
        context: ./postgres
        args:
          - POSTGRES_VERSION=${POSTGRES_VERSION}
      volumes:
        - ./.data/postgres:/var/lib/postgresql/data
        - ./postgres/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
      ports:
        - "${POSTGRES_PORT}:5432"
      environment:
        - POSTGRES_DB=${POSTGRES_DB}
        - POSTGRES_USER=${POSTGRES_USER}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

### Redis ################################################
    redis:
      build: ./redis
      volumes:
        - ${DATA_PATH_HOST}/redis:/data
      ports:
        - "${REDIS_PORT}:6379"

### Redis Cluster ##########################################
    redis-cluster:
      build: ./redis-cluster
      ports:
        - "${REDIS_CLUSTER_PORT_RANGE}:7000-7005"

### REDISWEBUI ################################################
    redis-webui:
      build:
        context: ./redis-webui
      environment:
        - ADMIN_USER=${REDIS_WEBUI_USERNAME}
        - ADMIN_PASS=${REDIS_WEBUI_PASSWORD}
        - REDIS_1_HOST=${REDIS_WEBUI_CONNECT_HOST}
        - REDIS_1_PORT=${REDIS_WEBUI_CONNECT_PORT}
      ports:
        - "${REDIS_WEBUI_PORT}:80"
      depends_on:
        - redis

### ElasticSearch ########################################
    elasticsearch-8:
      build:
        context: ./elasticsearch
        args:
          - ELK_VERSION=8.2.0
      volumes:
        - '${DATA_PATH_HOST}/elasticsearch-8:/usr/share/elasticsearch/data'
      environment:
        - node.name=web-node
        - cluster.name=web-cluster
        - bootstrap.memory_lock=true
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        - cluster.initial_master_nodes=web-node
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      ports:
        - "${ELASTICSEARCH_HOST_HTTP_PORT}:9200"
        - "${ELASTICSEARCH_HOST_TRANSPORT_PORT}:9300"

    elasticsearch-7:
      build:
        context: ./elasticsearch
        args:
          - ELK_VERSION=7.5.1
      volumes:
        - '${DATA_PATH_HOST}/elasticsearch-7:/usr/share/elasticsearch/data'
      environment:
        - node.name=web-node
        - cluster.name=web-cluster
        - bootstrap.memory_lock=true
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
        - cluster.initial_master_nodes=web-node
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      ports:
        - "${ELASTICSEARCH_HOST_HTTP_PORT}:9200"
        - "${ELASTICSEARCH_HOST_TRANSPORT_PORT}:9300"

    elasticsearch-6:
      build:
        context: ./elasticsearch
        args:
          - ELK_VERSION=6.8.10
      volumes:
        - '${DATA_PATH_HOST}/elasticsearch-6:/usr/share/elasticsearch/data'
      environment:
        - transport.host=127.0.0.1
        - cluster.name=web-cluster
        - bootstrap.memory_lock=true
        - xpack.security.enabled=false
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      ulimits:
        memlock:
          soft: -1
          hard: -1
        nofile:
          soft: 65536
          hard: 65536
      ports:
        - "${ELASTICSEARCH_HOST_HTTP_PORT}:9200"
        - "${ELASTICSEARCH_HOST_TRANSPORT_PORT}:9300"

### Kibana ##############################################
    kibana-8:
      build:
        context: ./kibana
        args:
          - ELK_VERSION=8.2.0
          - ELK_HOST=elasticsearch-8
          - KIBANA_HOST=kibana-8
      ports:
        - "${KIBANA_HTTP_PORT}:5601"
      volumes:
        # logs
        - ./.logs/nginx:/var/log/nginx
        - ./.logs/mysql-8:/var/log/mysql-8
      environment:
        ELASTICSEARCH_HOSTS: http://elasticsearch-8:9200
      depends_on:
        - elasticsearch-8

    kibana-7:
      build:
        context: ./kibana
        args:
          - ELK_VERSION=7.5.1
          - ELK_HOST=elasticsearch-7
          - KIBANA_HOST=kibana-7
      ports:
        - "${KIBANA_HTTP_PORT}:5601"
      volumes:
        # logs
        - ./.logs/nginx:/var/log/nginx
        - ./.logs/mysql-8:/var/log/mysql-8
      environment:
        ELASTICSEARCH_HOSTS: http://elasticsearch-7:9200
      depends_on:
        - elasticsearch-7

    kibana-6:
      build:
        context: ./kibana
        args:
          - ELK_VERSION=6.8.10
          - ELK_HOST=elasticsearch-6
          - KIBANA_HOST=kibana-6
      ports:
        - "${KIBANA_HTTP_PORT}:5601"
      volumes:
        # logs
        - ./.logs/nginx:/var/log/nginx
        - ./.logs/mysql-8:/var/log/mysql-8
      environment:
        ELASTICSEARCH_HOSTS: http://elasticsearch-6:9200
      depends_on:
        - elasticsearch-6

### Workspace ##############################################
    workspace:
      build:
        context: ./workspace
      volumes:
        - ${APP_CODE_PATH_HOST}:/var/www${APP_CODE_CONTAINER_FLAG}
        - ${HOME}/.ssh:/home/web/.ssh
        - ${HOME}/.ssh:/root/.ssh
        - ${LOCALHTTPS_PATH}:${LOCALHTTPS_PATH}
        - ./workspace/nginx/sites:/etc/nginx/sites-available
        - .bash-history/.zsh_history:/home/web/.zsh_history
        - .bash-history/.bash_history:/home/web/.bash_history
        # vscode-server
        - ./.vscode-server/extensions:/home/web/.vscode-server/extensions
        # logs
        - ./.logs/nginx:/var/log/nginx
        - ./.logs/mysql-8:/var/log/mysql-8
      ports:
        - "80:80"
        - "443:443"
